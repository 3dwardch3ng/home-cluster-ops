apiVersion: apps/v1
kind: Deployment
metadata:
  name: renovate
  namespace: renovate
  labels:
    app: renovate
spec:
  selector:
    matchLabels:
      app: renovate
  template:
    metadata:
      labels:
        app: renovate
    spec:
      containers:
        - name: renovate
          image: ghcr.io/mend/renovate-ce:7.4.0-full
          ports:
            - containerPort: 8080
          env:
            - name: MEND_RNV_ACCEPT_TOS
              value: y
            - name: MEND_RNV_LICENSE_KEY
              value: ${renovate_license_key}
            - name: MEND_RNV_PLATFORM
              value: github
            - name: MEND_RNV_GITHUB_APP_ID
              value: "938218"
            - name: RNV_GITHUB_PEM_FILE_PATH
              value: "/usr/src/app/rpi5-cluster-renovate.2024-07-05.private-key.pem"
            - name: MEND_RNV_WEBHOOK_SECRET
              value: ${github_app_webhook_secret}
            - name: MEND_RNV_ADMIN_API_ENABLED
              value: "true"
            - name: MEND_RNV_SERVER_API_SECRET
              value: ${server_api_secret}
            - name: GITHUB_COM_TOKEN
              value: ${github_pat}
            - name: MEND_RNV_AUTODISCOVER_FILTER
              value: "3dwardch3ng/home-cluster-ops"
            - name: MEND_RNV_ENQUEUE_JOBS_ON_STARTUP
              value: "enabled"
            - name: MEND_RNV_LOG_HISTORY_DIR
              value: "/logs"
          volumeMounts:
            - name: renovate-db
              mountPath: /db/
            - name: renovate-logs
              mountPath: /logs/
            - name: renovate-gh-app-pem
              mountPath: /usr/src/app/rpi5-cluster-renovate.2024-07-05.private-key.pem
      volumes:
        - name: renovate-db
          hostPath:
            path: /mnt/nfs/AppData/renovate/db
            type: Directory
        - name: renovate-logs
          hostPath:
            path: /mnt/nfs/AppData/renovate/logs
            type: Directory
        - name: renovate-gh-app-pem
          hostPath:
            path: /mnt/nfs/AppData/renovate/key/rpi5-cluster-renovate.2024-07-05.private-key.pem
            type: File