apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: jellyfin
  namespace: jellyfin
spec:
  releaseName: jellyfin
  targetNamespace: jellyfin
  chart:
    spec:
      chart: jellyfin
      sourceRef:
        kind: HelmRepository
        name: beluga-cloud
        namespace: flux-system
  interval: 1h
  install:
    remediation:
      retries: 3
  values:
    persistence:
      config:
        enabled: true
        volumeClaimSpec:
          accessModes:
            - ReadWriteOnce
          volumeName: jellyfin-config-pv
      data:
        enabled: true
        volumeClaimSpec:
          accessModes:
            - ReadWriteOnce
          volumeName: jellyfin-data-pv
    jellyfin:
      mediaVolumes:
        - name: movies
          readOnly: false
          volumeSpec:
            storageClassName: local-path
            volumeMode: Filesystem
            capacity:
              storage: 8Gi
            accessModes:
              - ReadWriteOnce
            persistentVolumeReclaimPolicy: Retain
            local:
              path: "/mnt/nfs/AppData/jellyfin/media/movies"
            nodeAffinity:
              required:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: kubernetes.io/hostname
                        operator: In
                        values:
                          - rpi5-cluster-node-3
        - name: series
          readOnly: false
          volumeSpec:
            storageClassName: local-path
            volumeMode: Filesystem
            capacity:
              storage: 8Gi
            accessModes:
              - ReadWriteOnce
            persistentVolumeReclaimPolicy: Retain
            local:
              path: "/mnt/nfs/AppData/jellyfin/media/series"
            nodeAffinity:
              required:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: kubernetes.io/hostname
                        operator: In
                        values:
                          - rpi5-cluster-node-3
        - name: music
          readOnly: false
          volumeSpec:
            storageClassName: local-path
            volumeMode: Filesystem
            capacity:
              storage: 8Gi
            accessModes:
              - ReadWriteOnce
            persistentVolumeReclaimPolicy: Retain
            local:
              path: "/mnt/nfs/AppData/jellyfin/media/music"
            nodeAffinity:
              required:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: kubernetes.io/hostname
                        operator: In
                        values:
                          - rpi5-cluster-node-3
        - name: gv
          readOnly: false
          volumeSpec:
            storageClassName: local-path
            volumeMode: Filesystem
            capacity:
              storage: 8Gi
            accessModes:
              - ReadWriteOnce
            persistentVolumeReclaimPolicy: Retain
            local:
              path: "/mnt/nfs/AppData/jellyfin/media/gv"
            nodeAffinity:
              required:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: kubernetes.io/hostname
                        operator: In
                        values:
                          - rpi5-cluster-node-3
      persistentTranscodes: true

